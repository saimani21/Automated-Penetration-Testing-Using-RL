import os
import sys

# --- Ensure project root is on sys.path ---
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(CURRENT_DIR)
if PROJECT_ROOT not in sys.path:
    sys.path.insert(0, PROJECT_ROOT)

from stable_baselines3 import DQN  # noqa: E402
from env.dvwa_sqli_env import DVWASQLiEnv  # noqa: E402
from scripts.reward_utils import SQLI_PAYLOADS  # noqa: E402


def main():
    env = DVWASQLiEnv(base_url="http://127.0.0.1:4280", max_steps=3)

    model_path = os.path.join("models", "dqn_dvwa_sqli_hard.zip")
    if not os.path.exists(model_path):
        raise FileNotFoundError(f"Model not found at {model_path}. Train it first.")

    model = DQN.load(model_path)

    obs, info = env.reset()
    done = False
    truncated = False
    step = 0

    print("[RUN] Using trained agent to exploit DVWA SQLi...")
    while not (done or truncated):
        action, _ = model.predict(obs, deterministic=True)
        payload = SQLI_PAYLOADS[int(action)]
        obs, reward, done, truncated, step_info = env.step(int(action))
        step += 1

        print(
            f"Step {step}: action={int(action)}, payload={repr(payload)}, "
            f"success={step_info['success']}, reward={reward:.2f}"
        )

        if step_info["success"]:
            print("\n[RESULT] Agent successfully triggered SQL injection!")
            break

    if not step_info["success"]:
        print("\n[RESULT] Agent did NOT manage to exploit SQLi in this episode.")

    env.close()


if __name__ == "__main__":
    main()
