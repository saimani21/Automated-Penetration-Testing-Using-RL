import numpy as np
import gymnasium as gym
from gymnasium import spaces

from scripts.dvwa_client import DVWAClient
from scripts.reward_utils import SQLI_PAYLOADS, is_sqli_success, has_error_indicator


class DVWASQLiEnv(gym.Env):
    """
    Gymnasium environment wrapping DVWA SQL Injection page.

    - Action: choose a payload index from SQLI_PAYLOADS
    - Observation: simple numeric vector based on last response
    - Reward design (harder, more realistic):
        +10  for successful SQLi (multiple 'First name' rows)
        -0.5 per step to discourage brute force
        -5   extra penalty if episode ends with no success
    """

    metadata = {"render_modes": []}

    def __init__(self, base_url: str = "http://127.0.0.1:4280", max_steps: int = 3):
        super().__init__()

        self.base_url = base_url
        self.max_steps = max_steps

        self.client: DVWAClient | None = None
        self.step_count = 0

        # Discrete actions over payload library
        self.action_space = spaces.Discrete(len(SQLI_PAYLOADS))

        # Observation: [resp_len_norm, success_flag, error_flag, last_action_norm]
        # All values in [0, 1]
        self.observation_space = spaces.Box(
            low=0.0, high=1.0, shape=(4,), dtype=np.float32
        )

        self._last_success = False
        self._last_error = False
        self._last_resp_len = 0
        self._last_action = 0

    # ---------- Core RL API ----------

    def reset(self, seed=None, options=None):
        super().reset(seed=seed)
        self.step_count = 0

        # Fresh client & login each episode
        self.client = DVWAClient(base_url=self.base_url)
        ok = self.client.login()
        if ok:
            self.client.set_security_level("low")
        else:
            print("[DVWASQLiEnv] Warning: login failed during reset")

        # Initial observation: no action taken yet
        self._last_success = False
        self._last_error = False
        self._last_resp_len = 0
        self._last_action = 0

        obs = self._build_observation()
        info = {}
        return obs, info

    def step(self, action: int):
        assert self.client is not None, "Environment not reset() properly"

        self.step_count += 1
        self._last_action = int(action)

        payload = SQLI_PAYLOADS[action]

        # Send request
        html = self.client.sqli_request(payload)
        self._last_resp_len = len(html)
        self._last_success = is_sqli_success(html)
        self._last_error = has_error_indicator(html)

        # Base reward: per-step penalty
        reward = -0.5

        # Bonus for success
        if self._last_success:
            reward += 10.0

        # Extra minus for error indicators
        if self._last_error:
            reward -= 1.0

        # Episode termination
        terminated = False
        if self._last_success:
            terminated = True

        truncated = False
        if self.step_count >= self.max_steps and not self._last_success:
            truncated = True
            # Big penalty for failing to find injection within max steps
            reward -= 5.0

        obs = self._build_observation()
        info = {
            "payload": payload,
            "success": self._last_success,
            "error": self._last_error,
            "resp_len": self._last_resp_len,
        }

        return obs, reward, terminated, truncated, info

    # ---------- Helpers ----------

    def _build_observation(self) -> np.ndarray:
        # Normalize response length crudely (assuming < ~10k chars)
        resp_len_norm = min(self._last_resp_len / 10000.0, 1.0)
        success_flag = 1.0 if self._last_success else 0.0
        error_flag = 1.0 if self._last_error else 0.0
        last_action_norm = self._last_action / max(len(SQLI_PAYLOADS) - 1, 1)

        obs = np.array(
            [resp_len_norm, success_flag, error_flag, last_action_norm],
            dtype=np.float32,
        )
        return obs

    def render(self):
        # Optional: add debug prints here if you want
        pass

    def close(self):
        self.client = None
